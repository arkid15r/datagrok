import { GridCellRendererEx } from "./GridCellRendererEx";
import * as MathUtils from "../utils/MathUtils";
import * as RendUtils from './RendUtils';
import * as DG from 'datagrok-api/dg';
import * as TextUtils from "../utils/TextUtils";
const MONTHS = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
function isNullText(cell) {
    const bNull = cell === null || cell === undefined || cell.value === null || cell.value === undefined;
    return bNull;
}
function formatDate(nTime) {
    nTime = Math.floor(nTime);
    const date = new Date(nTime);
    const nMonth = date.getMonth() + 1;
    const nDay = date.getDate();
    const nYear = date.getFullYear();
    const str = nMonth.toString() + "-" + nDay + "-" + nYear;
    return str;
}
function formatDate2Day(nTime) {
    nTime = Math.floor(nTime);
    const date = new Date(nTime);
    const nDay = date.getDate();
    const str = nDay.toString();
    return str;
}
function formatDate2Month(nTime) {
    nTime = Math.floor(nTime);
    const date = new Date(nTime);
    const nMonth = date.getMonth();
    const str = MONTHS[nMonth];
    return str;
}
function formatDate2DayMonth(nTime) {
    nTime = Math.floor(nTime);
    const date = new Date(nTime);
    const nMonth = date.getMonth() + 1;
    const nDay = date.getDate();
    const str = MONTHS[nMonth] + " " + nDay;
    return str;
}
function formatDate2Year(nTime) {
    nTime = Math.floor(nTime);
    const date = new Date(nTime);
    const nYear = date.getFullYear();
    const str = nYear.toString();
    return str;
}
export class DateCellRenderer extends GridCellRendererEx {
    render(g, nX, nY, nW, nH, cellGrid, style) {
        const cell = cellGrid.cell;
        if (cell.column.type !== DG.COLUMN_TYPE.DATE_TIME) {
            return;
        }
        let nTime = NaN;
        const ob = cell.value;
        if (MathUtils.isNullValue(ob)) {
            nTime = NaN;
        }
        else if (typeof ob !== "number")
            nTime = ob.a;
        if (isNaN(nTime)) {
            return;
        }
        const str = formatDate(nTime);
        const strFont = style.font;
        if (strFont !== null && strFont !== undefined && strFont !== '') {
            g.font = strFont;
        }
        let tm = g.measureText(str);
        const nWLabel = Math.round(tm.width);
        if (nWLabel < nW) {
            RendUtils.renderXYCenteredText(str, g, nX, nY, nW, nH, style.font, 'black');
            return;
        }
        const nYInset = 2;
        tm = g.measureText('W');
        const nAscent = Math.abs(tm.actualBoundingBoxAscent);
        const nDescent = tm.actualBoundingBoxDescent;
        const nHFont = nAscent + nDescent;
        const bTwoLevel = nH - 2 * nHFont - 3 * nYInset >= 0;
        if (bTwoLevel) {
            let strMonthDay = formatDate2DayMonth(nTime);
            let strYear = formatDate2Year(nTime);
            tm = g.measureText(strMonthDay);
            const nWMonthDay = Math.round(tm.width);
            tm = g.measureText(strYear);
            const nWYear = Math.round(tm.width);
            if (nWMonthDay <= nW && nWYear <= nW) {
                const nYOffset = Math.floor((nH - 2 * nHFont - 3 * nYInset) / 2);
                RendUtils.renderXCenteredText(strMonthDay, g, nX, nY + nYOffset, nW, nH, style.font, 'black');
                RendUtils.renderXCenteredText(strYear, g, nX, nY + 2 * nYOffset + nHFont, nW, nH, style.font, 'black');
                return;
            }
            else if (nWMonthDay > nW) {
                const bTriLevel = nH - 3 * nHFont - 4 * nYInset >= 0;
                if (bTriLevel) {
                    let strMonth = formatDate2Month(nTime);
                    let strDay = formatDate2Day(nTime);
                    strDay = TextUtils.trimText(strDay, g, nW);
                    strMonth = TextUtils.trimText(strMonth, g, nW);
                    strYear = TextUtils.trimText(strYear, g, nW);
                    const nYOffset = Math.floor((nH - 3 * nHFont - 4 * nYInset) / 2);
                    RendUtils.renderXCenteredText(strMonth, g, nX, nY + nYOffset, nW, nH, style.font, 'black');
                    RendUtils.renderXCenteredText(strDay, g, nX, nY + 2 * nYOffset + nHFont, nW, nH, style.font, 'black');
                    RendUtils.renderXCenteredText(strYear, g, nX, nY + 3 * nYOffset + 2 * nHFont, nW, nH, style.font, 'black');
                    return;
                }
            }
            strMonthDay = TextUtils.trimText(strMonthDay, g, nW);
            strYear = TextUtils.trimText(strYear, g, nW);
            const nYOffset = Math.floor((nH - 2 * nHFont - 3 * nYInset) / 2);
            RendUtils.renderXCenteredText(strMonthDay, g, nX, nY + nYOffset, nW, nH, style.font, 'black');
            RendUtils.renderXCenteredText(strYear, g, nX, nY + 2 * nYOffset + nHFont, nW, nH, style.font, 'black');
            return;
        }
        RendUtils.renderXYCenteredText(str, g, nX, nY, nW, nH, style.font, 'black');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRGF0ZUNlbGxSZW5kZXJlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIkRhdGVDZWxsUmVuZGVyZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFDeEQsT0FBTyxLQUFLLFNBQVMsTUFBTSxvQkFBb0IsQ0FBQztBQUNoRCxPQUFPLEtBQUssU0FBUyxNQUFNLGFBQWEsQ0FBQTtBQUN4QyxPQUFPLEtBQUssRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBQ3RDLE9BQU8sS0FBSyxTQUFTLE1BQU0sb0JBQW9CLENBQUM7QUFFaEQsTUFBTSxNQUFNLEdBQUcsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDO0FBRXBHLFNBQVMsVUFBVSxDQUFDLElBQWM7SUFDaEMsTUFBTSxLQUFLLEdBQWEsSUFBSSxLQUFLLElBQUksSUFBSSxJQUFJLEtBQUssU0FBUyxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssSUFBSSxJQUFJLElBQUksQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDO0lBQy9HLE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQztBQUVELFNBQVMsVUFBVSxDQUFDLEtBQWM7SUFDaEMsS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7SUFFMUIsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLFFBQVEsRUFBRSxHQUFFLENBQUMsQ0FBQztJQUNsQyxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDNUIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFdB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QUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFDN0MsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEdBQUMsTUFBTSxHQUFHLENBQUMsR0FBQyxPQUFPLENBQUMsR0FBQyxDQUFDLENBQUMsQ0FBQztZQUMzRCxTQUFTLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLENBQUMsRUFBRSxFQUFFLEVBQUUsRUFBRSxHQUFHLFFBQVEsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUYsU0FBUyxDQUFDLG1CQUFtQixDQUFDLE9BQU8sRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsR0FBRyxDQUFDLEdBQUMsUUFBUSxHQUFHLE1BQU0sRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDckcsT0FBTztTQUNUO1FBRUQsU0FBUyxDQUFDLG9CQUFvQixDQUFDLEdBQUcsRUFBRSxDQUFDLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDOUUsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtHcmlkQ2VsbFJlbmRlcmVyRXh9IGZyb20gXCIuL0dyaWRDZWxsUmVuZGVyZXJFeFwiO1xyXG5pbXBvcnQgKiBhcyBNYXRoVXRpbHMgZnJvbSBcIi4uL3V0aWxzL01hdGhVdGlsc1wiO1xyXG5pbXBvcnQgKiBhcyBSZW5kVXRpbHMgZnJvbSAnLi9SZW5kVXRpbHMnXHJcbmltcG9ydCAqIGFzIERHIGZyb20gJ2RhdGFncm9rLWFwaS9kZyc7XHJcbmltcG9ydCAqIGFzIFRleHRVdGlscyBmcm9tIFwiLi4vdXRpbHMvVGV4dFV0aWxzXCI7XHJcblxyXG5jb25zdCBNT05USFMgPSBbJ0phbicsICdGZWInLCAnTWFyJywgJ0FwcicsICdNYXknLCAnSnVuJywgJ0p1bCcsICdBdWcnLCAnU2VwJywgJ09jdCcsICdOb3YnLCAnRGVjJ107XHJcblxyXG5mdW5jdGlvbiBpc051bGxUZXh0KGNlbGwgOiBERy5DZWxsKSA6IGJvb2xlYW4ge1xyXG4gIGNvbnN0IGJOdWxsIDogYm9vbGVhbiA9IGNlbGwgPT09IG51bGwgfHwgY2VsbCA9PT0gdW5kZWZpbmVkIHx8IGNlbGwudmFsdWUgPT09IG51bGwgfHwgY2VsbC52YWx1ZSA9PT0gdW5kZWZpbmVkO1xyXG4gIHJldHVybiBiTnVsbDtcclxufVxyXG5cclxuZnVuY3Rpb24gZm9ybWF0RGF0ZShuVGltZSA6IG51bWJlcikgOiBzdHJpbmcge1xyXG4gIG5UaW1lID0gTWF0aC5mbG9vcihuVGltZSk7XHJcblxyXG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShuVGltZSk7XHJcbiAgY29uc3Qgbk1vbnRoID0gZGF0ZS5nZXRNb250aCgpICsxO1xyXG4gIGNvbnN0IG5EYXkgPSBkYXRlLmdldERhdGUoKTtcclxuICBjb25zdCBuWWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTtcclxuXHJcbiAgY29uc3Qgc3RyID0gbk1vbnRoLnRvU3RyaW5nKCkgKyBcIi1cIiArIG5EYXkgKyBcIi1cIiArIG5ZZWFyO1xyXG4gIHJldHVybiBzdHI7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGZvcm1hdERhdGUyRGF5KG5UaW1lIDogbnVtYmVyKSA6IHN0cmluZyB7XHJcbiAgblRpbWUgPSBNYXRoLmZsb29yKG5UaW1lKTtcclxuXHJcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKG5UaW1lKTtcclxuICBjb25zdCBuRGF5ID0gZGF0ZS5nZXREYXRlKCk7XHJcblxyXG4gIGNvbnN0IHN0ciA9IG5EYXkudG9TdHJpbmcoKTtcclxuICByZXR1cm4gc3RyO1xyXG59XHJcblxyXG5mdW5jdGlvbiBmb3JtYXREYXRlMk1vbnRoKG5UaW1lIDogbnVtYmVyKSA6IHN0cmluZyB7XHJcbiAgblRpbWUgPSBNYXRoLmZsb29yKG5UaW1lKTtcclxuXHJcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKG5UaW1lKTtcclxuICBjb25zdCBuTW9udGggPSBkYXRlLmdldE1vbnRoKCk7XHJcbiAgY29uc3Qgc3RyID0gTU9OVEhTW25Nb250aF07XHJcbiAgcmV0dXJuIHN0cjtcclxufVxyXG5cclxuZnVuY3Rpb24gZm9ybWF0RGF0ZTJEYXlNb250aChuVGltZSA6IG51bWJlcikgOiBzdHJpbmcge1xyXG4gIG5UaW1lID0gTWF0aC5mbG9vcihuVGltZSk7XHJcblxyXG4gIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShuVGltZSk7XHJcbiAgY29uc3Qgbk1vbnRoID0gZGF0ZS5nZXRNb250aCgpICsxO1xyXG4gIGNvbnN0IG5EYXkgPSBkYXRlLmdldERhdGUoKTtcclxuXHJcbiAgY29uc3Qgc3RyID0gTU9OVEhTW25Nb250aF0gKyBcIiBcIiArIG5EYXk7XHJcbiAgcmV0dXJuIHN0cjtcclxufVxyXG5cclxuZnVuY3Rpb24gZm9ybWF0RGF0ZTJZZWFyKG5UaW1lIDogbnVtYmVyKSA6IHN0cmluZyB7XHJcbiAgblRpbWUgPSBNYXRoLmZsb29yKG5UaW1lKTtcclxuXHJcbiAgY29uc3QgZGF0ZSA9IG5ldyBEYXRlKG5UaW1lKTtcclxuICBjb25zdCBuWWVhciA9IGRhdGUuZ2V0RnVsbFllYXIoKTtcclxuXHJcbiAgY29uc3Qgc3RyID0gblllYXIudG9TdHJpbmcoKTtcclxuICByZXR1cm4gc3RyO1xyXG59XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIERhdGVDZWxsUmVuZGVyZXIgZXh0ZW5kcyBHcmlkQ2VsbFJlbmRlcmVyRXgge1xyXG4gIHJlbmRlcihnOiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIG5YOiBudW1iZXIsIG5ZOiBudW1iZXIsIG5XOiBudW1iZXIsIG5IOiBudW1iZXIsIGNlbGxHcmlkOiBERy5HcmlkQ2VsbCwgc3R5bGU6IERHLkdyaWRDZWxsU3R5bGUpOiB2b2lkIHtcclxuICAgIGNvbnN0IGNlbGw6IERHLkNlbGwgPSBjZWxsR3JpZC5jZWxsO1xyXG4gICAgaWYoY2VsbC5jb2x1bW4udHlwZSAhPT0gREcuQ09MVU1OX1RZUEUuREFURV9USU1FKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBsZXQgblRpbWUgPSBOYU47XHJcbiAgICBjb25zdCBvYiA9IGNlbGwudmFsdWU7XHJcbiAgICBpZihNYXRoVXRpbHMuaXNOdWxsVmFsdWUob2IpKSB7XHJcbiAgICAgIG5UaW1lID0gTmFOO1xyXG4gICAgfVxyXG4gICAgZWxzZSBpZiAodHlwZW9mIG9iICE9PSBcIm51bWJlclwiKVxyXG4gICAgICBuVGltZSA9IG9iLmE7XHJcblxyXG4gICAgaWYoaXNOYU4oblRpbWUpKSB7XHJcbiAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN0ciA9IGZvcm1hdERhdGUoblRpbWUpO1xyXG5cclxuICAgIGNvbnN0IHN0ckZvbnQgPSBzdHlsZS5mb250O1xyXG4gICAgaWYgKHN0ckZvbnQgIT09IG51bGwgJiYgc3RyRm9udCAhPT0gdW5kZWZpbmVkICYmIHN0ckZvbnQgIT09ICcnKSB7XHJcbiAgICAgIGcuZm9udCA9IHN0ckZvbnQ7XHJcbiAgICB9XHJcblxyXG4gICAgbGV0IHRtID0gZy5tZWFzdXJlVGV4dChzdHIpO1xyXG4gICAgY29uc3QgbldMYWJlbCA9IE1hdGgucm91bmQodG0ud2lkdGgpO1xyXG4gICAgaWYobldMYWJlbCA8IG5XKSB7XHJcbiAgICAgIFJlbmRVdGlscy5yZW5kZXJYWUNlbnRlcmVkVGV4dChzdHIsIGcsIG5YLCBuWSwgblcsIG5ILCBzdHlsZS5mb250LCAnYmxhY2snKTtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IG5ZSW5zZXQgPSAyO1xyXG4gICAgdG0gPSBnLm1lYXN1cmVUZXh0KCdXJyk7XHJcbiAgICBjb25zdCBuQXNjZW50ID0gTWF0aC5hYnModG0uYWN0dWFsQm91bmRpbmdCb3hBc2NlbnQpO1xyXG4gICAgY29uc3QgbkRlc2NlbnQgPSB0bS5hY3R1YWxCb3VuZGluZ0JveERlc2NlbnQ7XHJcbiAgICBjb25zdCBuSEZvbnQgOiBudW1iZXIgPSBuQXNjZW50ICsgbkRlc2NlbnQ7XHJcbiAgICBjb25zdCBiVHdvTGV2ZWwgPSBuSCAtIDIqbkhGb250IC0gMypuWUluc2V0ID49IDA7XHJcblxyXG4gICAgaWYoYlR3b0xldmVsKSB7XHJcbiAgICAgICAgbGV0IHN0ck1vbnRoRGF5ID0gZm9ybWF0RGF0ZTJEYXlNb250aChuVGltZSk7XHJcbiAgICAgICAgbGV0IHN0clllYXIgPSBmb3JtYXREYXRlMlllYXIoblRpbWUpO1xyXG4gICAgICAgIHRtID0gZy5tZWFzdXJlVGV4dChzdHJNb250aERheSk7XHJcbiAgICAgICAgY29uc3QgbldNb250aERheSA9IE1hdGgucm91bmQodG0ud2lkdGgpO1xyXG4gICAgICAgIHRtID0gZy5tZWFzdXJlVGV4dChzdHJZZWFyKTtcclxuICAgICAgICBjb25zdCBuV1llYXIgPSBNYXRoLnJvdW5kKHRtLndpZHRoKTtcclxuXHJcbiAgICAgICAgaWYobldNb250aERheSA8PSBuVyAmJiBuV1llYXIgPD0gblcpIHtcclxuICAgICAgICAgIGNvbnN0IG5ZT2Zmc2V0ID0gTWF0aC5mbG9vcigobkggLSAyKm5IRm9udCAtIDMqbllJbnNldCkvMik7XHJcbiAgICAgICAgICBSZW5kVXRpbHMucmVuZGVyWENlbnRlcmVkVGV4dChzdHJNb250aERheSwgZywgblgsIG5ZICsgbllPZmZzZXQsIG5XLCBuSCwgc3R5bGUuZm9udCwgJ2JsYWNrJyk7XHJcbiAgICAgICAgICBSZW5kVXRpbHMucmVuZGVyWENlbnRlcmVkVGV4dChzdHJZZWFyLCBnLCBuWCwgblkgKyAyKm5ZT2Zmc2V0ICsgbkhGb250LCBuVywgbkgsIHN0eWxlLmZvbnQsICdibGFjaycpO1xyXG4gICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgfVxyXG4gICAgICAgZWxzZSBpZihuV01vbnRoRGF5ID4gblcpIHtcclxuICAgICAgICAgIGNvbnN0IGJUcmlMZXZlbCA9IG5IIC0gMypuSEZvbnQgLSA0Km5ZSW5zZXQgPj0gMDtcclxuICAgICAgICAgIGlmIChiVHJpTGV2ZWwpIHtcclxuICAgICAgICAgICAgbGV0IHN0ck1vbnRoID0gZm9ybWF0RGF0ZTJNb250aChuVGltZSk7XHJcbiAgICAgICAgICAgIGxldCBzdHJEYXkgPSBmb3JtYXREYXRlMkRheShuVGltZSk7XHJcbiAgICAgICAgICAgIHN0ckRheSA9IFRleHRVdGlscy50cmltVGV4dChzdHJEYXksIGcsIG5XKTtcclxuICAgICAgICAgICAgc3RyTW9udGggPSBUZXh0VXRpbHMudHJpbVRleHQoc3RyTW9udGgsIGcsIG5XKTtcclxuICAgICAgICAgICAgc3RyWWVhciA9IFRleHRVdGlscy50cmltVGV4dChzdHJZZWFyLCBnLCBuVyk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5ZT2Zmc2V0ID0gTWF0aC5mbG9vcigobkggLSAzICogbkhGb250IC0gNCAqIG5ZSW5zZXQpIC8gMik7XHJcbiAgICAgICAgICAgIFJlbmRVdGlscy5yZW5kZXJYQ2VudGVyZWRUZXh0KHN0ck1vbnRoLCBnLCBuWCwgblkgKyBuWU9mZnNldCwgblcsIG5ILCBzdHlsZS5mb250LCAnYmxhY2snKTtcclxuICAgICAgICAgICAgUmVuZFV0aWxzLnJlbmRlclhDZW50ZXJlZFRleHQoc3RyRGF5LCBnLCBuWCwgblkgKyAyICogbllPZmZzZXQgKyBuSEZvbnQsIG5XLCBuSCwgc3R5bGUuZm9udCwgJ2JsYWNrJyk7XHJcbiAgICAgICAgICAgIFJlbmRVdGlscy5yZW5kZXJYQ2VudGVyZWRUZXh0KHN0clllYXIsIGcsIG5YLCBuWSArIDMgKiBuWU9mZnNldCArIDIgKiBuSEZvbnQsIG5XLCBuSCwgc3R5bGUuZm9udCwgJ2JsYWNrJyk7XHJcbiAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICBzdHJNb250aERheSA9IFRleHRVdGlscy50cmltVGV4dChzdHJNb250aERheSwgZywgblcpO1xyXG4gICAgICAgc3RyWWVhciA9IFRleHRVdGlscy50cmltVGV4dChzdHJZZWFyLCBnLCBuVyk7XHJcbiAgICAgICBjb25zdCBuWU9mZnNldCA9IE1hdGguZmxvb3IoKG5IIC0gMipuSEZvbnQgLSAzKm5ZSW5zZXQpLzIpO1xyXG4gICAgICAgUmVuZFV0aWxzLnJlbmRlclhDZW50ZXJlZFRleHQoc3RyTW9udGhEYXksIGcsIG5YLCBuWSArIG5ZT2Zmc2V0LCBuVywgbkgsIHN0eWxlLmZvbnQsICdibGFjaycpO1xyXG4gICAgICAgUmVuZFV0aWxzLnJlbmRlclhDZW50ZXJlZFRleHQoc3RyWWVhciwgZywgblgsIG5ZICsgMipuWU9mZnNldCArIG5IRm9udCwgblcsIG5ILCBzdHlsZS5mb250LCAnYmxhY2snKTtcclxuICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBSZW5kVXRpbHMucmVuZGVyWFlDZW50ZXJlZFRleHQoc3RyLCBnLCBuWCwgblksIG5XLCBuSCwgc3R5bGUuZm9udCwgJ2JsYWNrJyk7XHJcbiAgfVxyXG59XHJcbiJdfQ==
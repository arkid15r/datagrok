import * as DG from 'datagrok-api/dg';
import * as GridUtils from '../utils/GridUtils';
import * as TextUtils from '../utils/TextUtils';
import * as MathUtils from '../utils/MathUtils';
import { GridCellRendererEx } from "./GridCellRendererEx";
class ImageRequest {
    constructor(strIdImage, nW, nH) {
        this.m_strIdImage = strIdImage;
        this.m_nW = nW;
        this.m_nH = nH;
        this.m_bError = false;
    }
    isMatch(strIdImage, nW, nH) {
        const b = this.m_strIdImage === strIdImage && this.m_nW === nW && this.m_nH === nH;
        return b;
    }
    isError() {
        return this.m_bError;
    }
    setError(bError) {
        this.m_bError = bError;
    }
}
function paintImageReady(g, grid, strColName, strIdImageReady, imgReady, fnValueToImageId, nXOffset) {
    const bError = imgReady === null;
    let cellGridTmp;
    let obVal = null;
    let strVal = null;
    const arMinMaxRowIdxs = [-1, -1];
    GridUtils.fillVisibleViewportRows(arMinMaxRowIdxs, grid);
    const nRMin = arMinMaxRowIdxs[0];
    const nRMax = arMinMaxRowIdxs[1];
    for (let nR = nRMin; nR <= nRMax; ++nR) {
        cellGridTmp = grid.cell(strColName, nR);
        if (!(cellGridTmp instanceof DG.GridCell) || !(cellGridTmp.cell instanceof DG.Cell)) {
            continue;
        }
        obVal = cellGridTmp.cell.value;
        strVal = fnValueToImageId(obVal);
        if (strVal === strIdImageReady) {
            if (bError) {
                g.font = cellGridTmp.style.font === null ? "10px Dialog" : cellGridTmp.style.font;
                const rc = cellGridTmp.bounds;
                const nX = isNaN(nXOffset) ? rc.x : nXOffset;
                const nW = isNaN(nXOffset) ? rc.width : g.canvas.width;
                g.fillStyle = 'white';
                g.fillRect(nX, rc.y, nW, rc.height);
                const str = TextUtils.trimText('Error', g, nW);
                const tm = g.measureText(str);
                let nWLabel = tm.width;
                const nAscent = Math.abs(tm.actualBoundingBoxAscent);
                const nDescent = tm.actualBoundingBoxDescent;
                const nHFont = nAscent + nDescent;
                g.fillStyle = 'red';
                g.textAlign = 'start';
                const nXX = nX + ((nW - nWLabel) >> 1);
                const nYY = rc.y + Math.floor((rc.height + nHFont) / 2);
                g.fillText(str, nXX, nYY);
            }
            else {
                const rc = cellGridTmp.bounds;
                const nX = isNaN(nXOffset) ? rc.x : nXOffset;
                const nW = isNaN(nXOffset) ? rc.width : g.canvas.width;
                g.drawImage(imgReady, nX, rc.y, nW, rc.height);
            }
        }
    }
}
export class LoadableImageRenderer extends GridCellRendererEx {
    constructor() {
        super();
        this.m_mapImages = new Map();
        this.m_bCellsAdjusting = false;
    }
    valueToImageId(obValue) {
        return obValue === undefined || obValue === null ? null : obValue.toString();
    }
    createImage(strImageId, nWImage, nHImage, fnImageRadyCallback) {
    }
    onResizeWidth(colGridOrPinned, grid, nWCol, bAdjusting) {
        const nHRow = GridUtils.getGridRowHeight(grid);
        this.onResize(colGridOrPinned, grid, nWCol, nHRow, bAdjusting);
    }
    onResizeHeight(colGridOrPinned, grid, nHRow, bAdjusting) {
        const nWCol = colGridOrPinned instanceof DG.GridColumn ? colGridOrPinned.width : colGridOrPinned.getWidth();
        this.onResize(colGridOrPinned, grid, nWCol, nHRow, bAdjusting);
    }
    onResize(colGridOrPinned, grid, nWCol, nHRow, bAdjusting) {
        if (!MathUtils.isStrictInt(nWCol)) {
            console.error('Image width is not an integer: ' + nWCol + " Will be converted to " + Math.floor(nWCol));
            nWCol = Math.floor(nWCol);
        }
        if (!MathUtils.isStrictInt(nHRow)) {
            console.error('Image height is not an integer: ' + nHRow + " Will be converted to " + Math.floor(nHRow));
            nHRow = Math.floor(nHRow);
        }
        this.m_bCellsAdjusting = bAdjusting;
        if (bAdjusting) {
            return;
        }
        const bGridCol = colGridOrPinned instanceof DG.GridColumn;
        if (!bGridCol && colGridOrPinned.getGridColumn() === null) {
            return;
        }
        let col = null;
        if (bGridCol) {
            col = colGridOrPinned.column;
        }
        else {
            const colGrid = colGridOrPinned.getGridColumn();
            if (colGrid === null) {
                col = null;
            }
            else {
                col = colGrid.column;
            }
        }
        if (col === null) {
            return;
        }
        const arRowIdxs = new Array(2);
        GridUtils.fillVisibleViewportRows(arRowIdxs, grid);
        const nRowMin = arRowIdxs[0];
        const nRowMax = arRowIdxs[1];
        let cell = null;
        let nRecord = -1;
        let obValue = null;
        let strImageId = null;
        for (let nRow = nRowMin; nRow <= nRowMax; ++nRow) {
            cell = grid.cell(col.name, nRow);
            if (cell.tableRowIndex === null) {
                continue;
            }
            nRecord = cell.tableRowIndex;
            obValue = col.get(nRecord);
            strImageId = this.valueToImageId(obValue);
            if (strImageId === null || strImageId.length === 0) {
                continue;
            }
            const strColNameTmp = col.name;
            let request = this.m_mapImages.get(strImageId);
            if (request instanceof ImageRequest && request.isMatch(strImageId, nWCol, nHRow)) {
                return;
            }
            request = new ImageRequest(strImageId, nWCol, nHRow);
            this.m_mapImages.set(strImageId, request);
            const eCanVasSource = bGridCol ? grid.canvas : colGridOrPinned.getRoot();
            const rendererThis = this;
            this.createImage(strImageId, nWCol, nHRow, (strrIdImage, imgNew) => {
                if (imgNew === null) {
                    const req = rendererThis.m_mapImages.get(strrIdImage);
                    req.setError(true);
                    //return;
                }
                else {
                    rendererThis.m_mapImages.set(strrIdImage, imgNew);
                }
                if (eCanVasSource === null) {
                    return;
                }
                const g = eCanVasSource.getContext("2d");
                if (g === null) {
                    return;
                }
                let nXOffset = NaN;
                if (eCanVasSource !== grid.canvas) { //pinned column, or something else
                    nXOffset = 0;
                }
                paintImageReady(g, grid, strColNameTmp, strrIdImage, imgNew, rendererThis.valueToImageId, nXOffset);
            });
        }
    }
    render(g, nX, nY, nW, nH, value, context) {
        if (!MathUtils.isStrictInt(nW)) {
            console.error('Image width is not an integer: ' + nW + " Will be converted to " + Math.floor(nW));
            nW = Math.floor(nW);
        }
        if (!MathUtils.isStrictInt(nH)) {
            console.error('Image height is not an integer: ' + nH + " Will be converted to " + Math.floor(nH));
            nH = Math.floor(nH);
        }
        const cellGrid = value;
        const obValue = cellGrid.cell.value;
        const strImageId = this.valueToImageId(obValue);
        if (strImageId === null || strImageId === undefined || strImageId == '') {
            g.fillStyle = 'white';
            g.fillRect(nX, nY, nW, nH);
            return;
        }
        if (!this.m_bCellsAdjusting) {
            const img = this.m_mapImages.get(strImageId);
            if (!(img instanceof ImageRequest) && img !== undefined && img !== null && img.width === nW && img.height === nH) {
                g.drawImage(img, nX, nY, nW, nH);
                return;
            }
        }
        g.fillStyle = "Gray";
        let str = '';
        if (this.m_bCellsAdjusting) {
            str = 'Updating...';
        }
        else {
            const req = this.m_mapImages.get(strImageId);
            if (req instanceof ImageRequest && req.isError()) {
                str = 'Error';
                g.fillStyle = "red";
            }
            else {
                str = 'Loading...';
            }
        }
        //let str = this.m_bCellsAdjusting ? "Updating..." : "Loading...";
        g.font = cellGrid.style.font === null ? "10px Dialog" : cellGrid.style.font;
        str = TextUtils.trimText(str, g, nW);
        const tm = g.measureText(str);
        let nWLabel = tm.width;
        const nAscent = Math.abs(tm.actualBoundingBoxAscent);
        const nDescent = tm.actualBoundingBoxDescent;
        const nHFont = nAscent + nDescent;
        g.textAlign = 'start';
        const nXX = nX + ((nW - nWLabel) >> 1);
        const nYY = nY + Math.floor((nH + nHFont) / 2);
        g.fillText(str, nXX, nYY);
        if (this.m_bCellsAdjusting) {
            return;
        }
        const grid = cellGrid.grid;
        const rendererThis = this;
        const strColNameTmp = cellGrid.gridColumn.name;
        let request = this.m_mapImages.get(strImageId);
        if (request instanceof ImageRequest && request.isMatch(strImageId, nW, nH)) {
            return;
        }
        request = new ImageRequest(strImageId, nW, nH);
        this.m_mapImages.set(strImageId, request);
        const eCanvasTmp = g.canvas;
        let nXOffset = NaN;
        if (g.canvas !== grid.canvas) { //pinned column, or something else
            nXOffset = nX;
        }
        //console.log('Sending request : ' + strImageId + " " + nW + " " + nH + " " + nXOffset);
        this.createImage(strImageId, nW, nH, (strIdImageReady, imgReady) => {
            if (imgReady === null) {
                const request = rendererThis.m_mapImages.get(strIdImageReady);
                request.setError(true);
                //return;
            }
            else {
                //console.log('Request Ready: ' + strImageId + " " + nW + " " + nH);
                rendererThis.m_mapImages.set(strIdImageReady, imgReady);
            }
            const graphics = eCanvasTmp.getContext("2d");
            if (graphics === null) {
                return;
            }
            paintImageReady(graphics, grid, strColNameTmp, strIdImageReady, imgReady, rendererThis.valueToImageId, nXOffset);
        });
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTG9hZGFibGVJbWFnZVJlbmRlcmVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiTG9hZGFibGVJbWFnZVJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFDdEMsT0FBTyxLQUFLLFNBQVMsTUFBTSxvQkFBb0IsQ0FBQztBQUNoRCxPQUFPLEtBQUssU0FBUyxNQUFNLG9CQUFvQixDQUFDO0FBQ2hELE9BQU8sS0FBSyxTQUFTLE1BQU0sb0JBQW9CLENBQUM7QUFDaEQsT0FBTyxFQUFDLGtCQUFrQixFQUFDLE1BQU0sc0JBQXNCLENBQUM7QUFHeEQsTUFBTSxZQUFZO0lBQ2hCLFlBQVksVUFBbUIsRUFBRSxFQUFXLEVBQUUsRUFBVztRQUN2RCxJQUFJLENBQUMsWUFBWSxHQUFHLFVBQVUsQ0FBQztRQUMvQixJQUFJLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNmLElBQUksQ0FBQyxJQUFJLEdBQUcsRUFBRSxDQUFDO1FBQ2YsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7SUFDeEIsQ0FBQztJQUVELE9BQU8sQ0FBQyxVQUFtQixFQUFFLEVBQVcsRUFBRSxFQUFXO1FBQ25ELE1BQU0sQ0FBQyxHQUFhLElBQUksQ0FBQyxZQUFZLEtBQUssVUFBVSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssRUFBRSxJQUFJLElBQUksQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQzdGLE9BQU8sQ0FBQyxDQUFDO0lBQ1gsQ0FBQztJQUVELE9BQU87UUFDTCxPQUFPLElBQUksQ0FBQyxRQUFRLENBQUM7SUFDdkIsQ0FBQztJQUVELFFBQVEsQ0FBQyxNQUFnQjtRQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLE1BQU0sQ0FBQztJQUN6QixDQUFDO0NBTUY7QUFHRCxTQUFTLGVBQWUsQ0FBQyxDQUE0QixFQUFFLElBQWMsRUFBRSxVQUFtQixFQUFFLGVBQXdCLEVBQUUsUUFBYyxFQUFFLGdCQUEyQixFQUFFLFFBQWlCO0lBQ2xMLE1BQU0sTUFBTSxHQUFHLFFBQVEsS0FBSyxJQUFJLENBQUM7SUFDakMsSUFBSSxXQUF3QixDQUFDO0lBQzdCLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQztJQUNqQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUM7SUFDbEIsTUFBTSxlQUFlLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLFNBQVMsQ0FBQyx1QkFBdUIsQ0FBQyxlQUFlLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDekQsTUFBTSxLQUFLLEdBQUcsZUFBZSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pDLE1BQU0sS0FBSyxHQUFHLGVBQWUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNqQyxLQUFLLElBQUksRUFBRSxHQUFHLEtBQUssRUFBRSxFQUFFLElBQUksS0FBSyxFQUFFLEVBQUUsRUFBRSxFQUFFO1FBQ3RDLFdBQVcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsQ0FBQztRQUN4QyxJQUFJLENBQUMsQ0FBQyxXQUFXLFlBQVksRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxXQUFXLENBQUMsSUFBSSxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRTtZQUNwRixTQUFTO1NBQ1Q7UUFFSCxLQUFLLEdBQUcsV0FBVyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUM7UUFDL0IsTUFBTSxHQUFHLGdCQUFnQixDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ2pDLElBQUksTUFBTSxLQUFLLGVBQWUsRUFBRTtZQUM5QixJQUFHLE1BQU0sRUFBRTtnQkFDVCxDQUFDLENBQUMsSUFBSSxHQUFHLFdBQVcsQ0FBQyxLQUFLLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQztnQkFDbEYsTUFBTSxFQUFFLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FBQztnQkFDOUIsTUFBTSxFQUFFLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUM7Z0JBQzdDLE1BQU0sRUFBRSxHQUFHLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7Z0JBQ3ZELENBQUMsQ0FBQyxTQUFTLEdBQUcsT0FBTyxDQUFDO2dCQUN0QixDQUFDLENBQUMsUUFBUSxDQUFDLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBRXBDLE1BQU0sR0FBRyxHQUFHLFNBQVMsQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztnQkFFL0MsTUFBTSxFQUFFLEdBQUcsQ0FBQyxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDOUIsSUFBSSxPQUFPLEdBQUcsRUFBRSxDQUFDLEtBQUssQ0FBQztnQkFFdkIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsdUJBQXVCLENBQUMsQ0FBQztnQkFDckQsTUFBTSxRQUFRLEdBQUcsRUFBRSxDQUFDLHdCQUF3QixDQUFDO2dCQUM3QyxNQUFNLE1BQU0sR0FBRyxPQUFPLEdBQUcsUUFBUSxDQUFDO2dCQUVsQyxDQUFDLENBQUMsU0FBUyxHQUFHLEtBQUssQ0FBQztnQkFDcEIsQ0FBQyxDQUFDLFNBQVMsR0FBRyxPQUFPLENBQUM7Z0JBQ3RCLE1BQU0sR0FBRyxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUMsRUFBRSxHQUFHLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO2dCQUN2QyxNQUFNLEdBQUcsR0FBRyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUks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QUFFLEVBQUUsRUFBRSxFQUFFLENBQUMsZUFBdUIsRUFBRSxRQUFhLEVBQUUsRUFBRTtZQUM5RSxJQUFJLFFBQVEsS0FBSyxJQUFJLEVBQUU7Z0JBQ3JCLE1BQU0sT0FBTyxHQUFHLFlBQVksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUM5RCxPQUFPLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN2QixTQUFTO2FBQ1Y7aUJBQ0k7Z0JBQ0gsb0VBQW9FO2dCQUNwRSxZQUFZLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDekQ7WUFFRCxNQUFNLFFBQVEsR0FBRyxVQUFVLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdDLElBQUksUUFBUSxLQUFLLElBQUksRUFBRTtnQkFDckIsT0FBTzthQUNSO1lBRUQsZUFBZSxDQUFDLFFBQVEsRUFBRSxJQUFJLEVBQUUsYUFBYSxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsWUFBWSxDQUFDLGNBQWMsRUFBRSxRQUFRLENBQUMsQ0FBQztRQUNuSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FJRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIERHIGZyb20gJ2RhdGFncm9rLWFwaS9kZyc7XHJcbmltcG9ydCAqIGFzIEdyaWRVdGlscyBmcm9tICcuLi91dGlscy9HcmlkVXRpbHMnO1xyXG5pbXBvcnQgKiBhcyBUZXh0VXRpbHMgZnJvbSAnLi4vdXRpbHMvVGV4dFV0aWxzJztcclxuaW1wb3J0ICogYXMgTWF0aFV0aWxzIGZyb20gJy4uL3V0aWxzL01hdGhVdGlscyc7XHJcbmltcG9ydCB7R3JpZENlbGxSZW5kZXJlckV4fSBmcm9tIFwiLi9HcmlkQ2VsbFJlbmRlcmVyRXhcIjtcclxuaW1wb3J0IHtQaW5uZWRDb2x1bW59IGZyb20gXCIuLi9waW5uZWQvUGlubmVkQ29sdW1uXCI7XHJcblxyXG5jbGFzcyBJbWFnZVJlcXVlc3Qge1xyXG4gIGNvbnN0cnVjdG9yKHN0cklkSW1hZ2UgOiBzdHJpbmcsIG5XIDogbnVtYmVyLCBuSCA6IG51bWJlcikge1xyXG4gICAgdGhpcy5tX3N0cklkSW1hZ2UgPSBzdHJJZEltYWdlO1xyXG4gICAgdGhpcy5tX25XID0gblc7XHJcbiAgICB0aGlzLm1fbkggPSBuSDtcclxuICAgIHRoaXMubV9iRXJyb3IgPSBmYWxzZTtcclxuICB9XHJcblxyXG4gIGlzTWF0Y2goc3RySWRJbWFnZSA6IHN0cmluZywgblcgOiBudW1iZXIsIG5IIDogbnVtYmVyKSA6IGJvb2xlYW4ge1xyXG4gICAgY29uc3QgYiA6IGJvb2xlYW4gPSB0aGlzLm1fc3RySWRJbWFnZSA9PT0gc3RySWRJbWFnZSAmJiB0aGlzLm1fblcgPT09IG5XICYmIHRoaXMubV9uSCA9PT0gbkg7XHJcbiAgICByZXR1cm4gYjtcclxuICB9XHJcblxyXG4gIGlzRXJyb3IoKSA6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRoaXMubV9iRXJyb3I7XHJcbiAgfVxyXG5cclxuICBzZXRFcnJvcihiRXJyb3IgOiBib29sZWFuKSA6IHZvaWQge1xyXG4gICAgdGhpcy5tX2JFcnJvciA9IGJFcnJvcjtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgbV9zdHJJZEltYWdlIDogc3RyaW5nO1xyXG4gIHByaXZhdGUgbV9uVyA6IG51bWJlcjtcclxuICBwcml2YXRlIG1fbkggOiBudW1iZXI7XHJcbiAgcHJpdmF0ZSBtX2JFcnJvciA6IGJvb2xlYW47XHJcbn1cclxuXHJcblxyXG5mdW5jdGlvbiBwYWludEltYWdlUmVhZHkoZyA6IENhbnZhc1JlbmRlcmluZ0NvbnRleHQyRCwgZ3JpZCA6IERHLkdyaWQsIHN0ckNvbE5hbWUgOiBzdHJpbmcsIHN0cklkSW1hZ2VSZWFkeSA6IHN0cmluZywgaW1nUmVhZHkgOiBhbnksIGZuVmFsdWVUb0ltYWdlSWQgOiBGdW5jdGlvbiwgblhPZmZzZXQgOiBudW1iZXIpIDogdm9pZCB7XHJcbiAgY29uc3QgYkVycm9yID0gaW1nUmVhZHkgPT09IG51bGw7XHJcbiAgbGV0IGNlbGxHcmlkVG1wOiBERy5HcmlkQ2VsbDtcclxuICBsZXQgb2JWYWwgPSBudWxsO1xyXG4gIGxldCBzdHJWYWwgPSBudWxsO1xyXG4gIGNvbnN0IGFyTWluTWF4Um93SWR4cyA9IFstMSwgLTFdO1xyXG4gIEdyaWRVdGlscy5maWxsVmlzaWJsZVZpZXdwb3J0Um93cyhhck1pbk1heFJvd0lkeHMsIGdyaWQpO1xyXG4gIGNvbnN0IG5STWluID0gYXJNaW5NYXhSb3dJZHhzWzBdO1xyXG4gIGNvbnN0IG5STWF4ID0gYXJNaW5NYXhSb3dJZHhzWzFdO1xyXG4gIGZvciAobGV0IG5SID0gblJNaW47IG5SIDw9IG5STWF4OyArK25SKSB7XHJcbiAgICBjZWxsR3JpZFRtcCA9IGdyaWQuY2VsbChzdHJDb2xOYW1lLCBuUik7XHJcbiAgICBpZiAoIShjZWxsR3JpZFRtcCBpbnN0YW5jZW9mIERHLkdyaWRDZWxsKSB8fCAhKGNlbGxHcmlkVG1wLmNlbGwgaW5zdGFuY2VvZiBERy5DZWxsKSkge1xyXG4gICAgIGNvbnRpbnVlO1xyXG4gICAgfVxyXG5cclxuICBvYlZhbCA9IGNlbGxHcmlkVG1wLmNlbGwudmFsdWU7XHJcbiAgc3RyVmFsID0gZm5WYWx1ZVRvSW1hZ2VJZChvYlZhbCk7XHJcbiAgaWYgKHN0clZhbCA9PT0gc3RySWRJbWFnZVJlYWR5KSB7XHJcbiAgICBpZihiRXJyb3IpIHtcclxuICAgICAgZy5mb250ID0gY2VsbEdyaWRUbXAuc3R5bGUuZm9udCA9PT0gbnVsbCA/IFwiMTBweCBEaWFsb2dcIiA6IGNlbGxHcmlkVG1wLnN0eWxlLmZvbnQ7XHJcbiAgICAgIGNvbnN0IHJjID0gY2VsbEdyaWRUbXAuYm91bmRzO1xyXG4gICAgICBjb25zdCBuWCA9IGlzTmFOKG5YT2Zmc2V0KSA/IHJjLnggOiBuWE9mZnNldDtcclxuICAgICAgY29uc3QgblcgPSBpc05hTihuWE9mZnNldCkgPyByYy53aWR0aCA6IGcuY2FudmFzLndpZHRoO1xyXG4gICAgICBnLmZpbGxTdHlsZSA9ICd3aGl0ZSc7XHJcbiAgICAgIGcuZmlsbFJlY3QoblgsIHJjLnksIG5XLCByYy5oZWlnaHQpO1xyXG5cclxuICAgICAgY29uc3Qgc3RyID0gVGV4dFV0aWxzLnRyaW1UZXh0KCdFcnJvcicsIGcsIG5XKTtcclxuXHJcbiAgICAgIGNvbnN0IHRtID0gZy5tZWFzdXJlVGV4dChzdHIpO1xyXG4gICAgICBsZXQgbldMYWJlbCA9IHRtLndpZHRoO1xyXG5cclxuICAgICAgY29uc3QgbkFzY2VudCA9IE1hdGguYWJzKHRtLmFjdHVhbEJvdW5kaW5nQm94QXNjZW50KTtcclxuICAgICAgY29uc3QgbkRlc2NlbnQgPSB0bS5hY3R1YWxCb3VuZGluZ0JveERlc2NlbnQ7XHJcbiAgICAgIGNvbnN0IG5IRm9udCA9IG5Bc2NlbnQgKyBuRGVzY2VudDtcclxuXHJcbiAgICAgIGcuZmlsbFN0eWxlID0gJ3JlZCc7XHJcbiAgICAgIGcudGV4dEFsaWduID0gJ3N0YXJ0JztcclxuICAgICAgY29uc3QgblhYID0gblggKyAoKG5XIC0gbldMYWJlbCkgPj4gMSk7XHJcbiAgICAgIGNvbnN0IG5ZWSA9IHJjLnkgKyBNYXRoLmZsb29yKChyYy5oZWlnaHQgKyBuSEZvbnQpIC8gMik7XHJcbiAgICAgIGcuZmlsbFRleHQoc3RyLCBuWFgsIG5ZWSk7XHJcbiAgICB9XHJcbiAgICBlbHNlIHtcclxuICAgICAgY29uc3QgcmMgPSBjZWxsR3JpZFRtcC5ib3VuZHM7XHJcbiAgICAgIGNvbnN0IG5YID0gaXNOYU4oblhPZmZzZXQpID8gcmMueCA6IG5YT2Zmc2V0O1xyXG4gICAgICBjb25zdCBuVyA9IGlzTmFOKG5YT2Zmc2V0KSA/IHJjLndpZHRoIDogZy5jYW52YXMud2lkdGg7XHJcbiAgICAgIGcuZHJhd0ltYWdlKGltZ1JlYWR5LCBuWCwgcmMueSwgblcsIHJjLmhlaWdodCk7XHJcbiAgICB9XHJcbiAgfVxyXG4gfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgTG9hZGFibGVJbWFnZVJlbmRlcmVyIGV4dGVuZHMgR3JpZENlbGxSZW5kZXJlckV4IHtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gIH1cclxuXHJcbiAgdmFsdWVUb0ltYWdlSWQob2JWYWx1ZSA6IGFueSkgOiBzdHJpbmcgfCBudWxsIHtcclxuICAgIHJldHVybiBvYlZhbHVlID09PSB1bmRlZmluZWQgfHwgb2JWYWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBvYlZhbHVlLnRvU3RyaW5nKCk7XHJcbiAgfVxyXG5cclxuICBjcmVhdGVJbWFnZShzdHJJbWFnZUlkIDogc3RyaW5nLCBuV0ltYWdlIDogbnVtYmVyLCBuSEltYWdlIDogbnVtYmVyLCBmbkltYWdlUmFkeUNhbGxiYWNrIDogYW55KSA6IHZvaWQge1xyXG5cclxuICB9XHJcblxyXG4gIG9uUmVzaXplV2lkdGgoY29sR3JpZE9yUGlubmVkIDogREcuR3JpZENvbHVtbiB8IFBpbm5lZENvbHVtbiwgZ3JpZCA6IERHLkdyaWQsIG5XQ29sIDogbnVtYmVyLCBiQWRqdXN0aW5nIDogYm9vbGVhbikgOiB2b2lkICB7XHJcblxyXG4gICAgY29uc3QgbkhSb3cgPSBHcmlkVXRpbHMuZ2V0R3JpZFJvd0hlaWdodChncmlkKTtcclxuICAgIHRoaXMub25SZXNpemUoY29sR3JpZE9yUGlubmVkLCBncmlkLCBuV0NvbCwgbkhSb3csIGJBZGp1c3RpbmcpO1xyXG4gIH1cclxuXHJcbiAgb25SZXNpemVIZWlnaHQoY29sR3JpZE9yUGlubmVkIDogREcuR3JpZENvbHVtbiB8IFBpbm5lZENvbHVtbiwgZ3JpZCA6IERHLkdyaWQsIG5IUm93IDogbnVtYmVyLCBiQWRqdXN0aW5nIDogYm9vbGVhbikgOiB2b2lkIHtcclxuXHJcbiAgICBjb25zdCBuV0NvbCA9IGNvbEdyaWRPclBpbm5lZCBpbnN0YW5jZW9mIERHLkdyaWRDb2x1bW4gPyBjb2xHcmlkT3JQaW5uZWQud2lkdGggOiBjb2xHcmlkT3JQaW5uZWQuZ2V0V2lkdGgoKTtcclxuICAgIHRoaXMub25SZXNpemUoY29sR3JpZE9yUGlubmVkLCBncmlkLCBuV0NvbCwgbkhSb3csIGJBZGp1c3RpbmcpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvblJlc2l6ZShjb2xHcmlkT3JQaW5uZWQgOiBERy5HcmlkQ29sdW1uIHwgUGlubmVkQ29sdW1uLCBncmlkOiBERy5HcmlkLCBuV0NvbCA6IG51bWJlciwgbkhSb3cgOiBudW1iZXIsIGJBZGp1c3RpbmcgOiBib29sZWFuKSA6IHZvaWQge1xyXG5cclxuICAgIGlmKCFNYXRoVXRpbHMuaXNTdHJpY3RJbnQobldDb2wpKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ltYWdlIHdpZHRoIGlzIG5vdCBhbiBpbnRlZ2VyOiAnICsgbldDb2wgKyBcIiBXaWxsIGJlIGNvbnZlcnRlZCB0byBcIiArIE1hdGguZmxvb3IobldDb2wpKTtcclxuICAgICAgbldDb2wgPSBNYXRoLmZsb29yKG5XQ29sKTtcclxuICAgIH1cclxuXHJcbiAgICBpZighTWF0aFV0aWxzLmlzU3RyaWN0SW50KG5IUm93KSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdJbWFnZSBoZWlnaHQgaXMgbm90IGFuIGludGVnZXI6ICcgKyBuSFJvdyArIFwiIFdpbGwgYmUgY29udmVydGVkIHRvIFwiICsgTWF0aC5mbG9vcihuSFJvdykpO1xyXG4gICAgICBuSFJvdyA9IE1hdGguZmxvb3IobkhSb3cpO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMubV9iQ2VsbHNBZGp1c3RpbmcgPSBiQWRqdXN0aW5nO1xyXG4gICAgaWYoYkFkanVzdGluZykge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYkdyaWRDb2wgPSBjb2xHcmlkT3JQaW5uZWQgaW5zdGFuY2VvZiBERy5HcmlkQ29sdW1uO1xyXG4gICAgaWYoIWJHcmlkQ29sICYmIGNvbEdyaWRPclBpbm5lZC5nZXRHcmlkQ29sdW1uKCkgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuO1xyXG4gICAgfVxyXG5cclxuICAgIGxldCBjb2wgPSBudWxsO1xyXG4gICAgaWYoYkdyaWRDb2wpIHtcclxuICAgICAgY29sID0gY29sR3JpZE9yUGlubmVkLmNvbHVtbjtcclxuICAgIH0gZWxzZSB7XHJcblxyXG4gICAgICBjb25zdCBjb2xHcmlkID0gY29sR3JpZE9yUGlubmVkLmdldEdyaWRDb2x1bW4oKTtcclxuICAgICAgaWYoY29sR3JpZCA9PT0gbnVsbCkge1xyXG4gICAgICAgIGNvbCA9IG51bGw7XHJcbiAgICAgIH1cclxuICAgICAgZWxzZSB7XHJcbiAgICAgICAgY29sID0gY29sR3JpZC5jb2x1bW47XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIGlmKGNvbCA9PT0gbnVsbCkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgYXJSb3dJZHhzID0gbmV3IEFycmF5PG51bWJlcj4oMik7XHJcbiAgICBHcmlkVXRpbHMuZmlsbFZpc2libGVWaWV3cG9ydFJvd3MoYXJSb3dJZHhzLCBncmlkKTtcclxuICAgIGNvbnN0IG5Sb3dNaW4gPSBhclJvd0lkeHNbMF07XHJcbiAgICBjb25zdCBuUm93TWF4ID0gYXJSb3dJZHhzWzFdO1xyXG4gICAgbGV0IGNlbGwgPSBudWxsO1xyXG4gICAgbGV0IG5SZWNvcmQgPSAtMTtcclxuICAgIGxldCBvYlZhbHVlID0gbnVsbDtcclxuICAgIGxldCBzdHJJbWFnZUlkIDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XHJcblxyXG4gICAgZm9yKGxldCBuUm93PW5Sb3dNaW47IG5Sb3c8PW5Sb3dNYXg7ICsrblJvdykge1xyXG4gICAgICAgIGNlbGwgPSBncmlkLmNlbGwoY29sLm5hbWUsIG5Sb3cpO1xyXG4gICAgICAgIGlmKGNlbGwudGFibGVSb3dJbmRleCA9PT0gbnVsbCkge1xyXG4gICAgICAgICAgY29udGludWU7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIG5SZWNvcmQgPSBjZWxsLnRhYmxlUm93SW5kZXg7XHJcbiAgICAgICAgb2JWYWx1ZSA9IGNvbC5nZXQoblJlY29yZCk7XHJcbiAgICAgICAgc3RySW1hZ2VJZCA9IHRoaXMudmFsdWVUb0ltYWdlSWQob2JWYWx1ZSk7XHJcbiAgICAgICAgaWYoc3RySW1hZ2VJZCA9PT0gbnVsbCB8fCBzdHJJbWFnZUlkLmxlbmd0aCA9PT0gMCkge1xyXG4gICAgICAgICBjb250aW51ZTtcclxuICAgICAgIH1cclxuXHJcbiAgICAgIGNvbnN0IHN0ckNvbE5hbWVUbXAgPSBjb2wubmFtZTtcclxuXHJcbiAgICAgIGxldCByZXF1ZXN0ID0gdGhpcy5tX21hcEltYWdlcy5nZXQoc3RySW1hZ2VJZCk7XHJcbiAgICAgIGlmIChyZXF1ZXN0IGluc3RhbmNlb2YgSW1hZ2VSZXF1ZXN0ICYmIHJlcXVlc3QuaXNNYXRjaChzdHJJbWFnZUlkLCBuV0NvbCwgbkhSb3cpKSB7XHJcbiAgICAgICAgcmV0dXJuO1xyXG4gICAgICB9XHJcblxyXG4gICAgICByZXF1ZXN0ID0gbmV3IEltYWdlUmVxdWVzdChzdHJJbWFnZUlkLCBuV0NvbCwgbkhSb3cpO1xyXG4gICAgICB0aGlzLm1fbWFwSW1hZ2VzLnNldChzdHJJbWFnZUlkLCByZXF1ZXN0KTtcclxuXHJcbiAgICAgIGNvbnN0IGVDYW5WYXNTb3VyY2UgPSBiR3JpZENvbCA/IGdyaWQuY2FudmFzIDogY29sR3JpZE9yUGlubmVkLmdldFJvb3QoKTtcclxuICAgICAgY29uc3QgcmVuZGVyZXJUaGlzID0gdGhpcztcclxuICAgICAgdGhpcy5jcmVhdGVJbWFnZShzdHJJbWFnZUlkLCBuV0NvbCwgbkhSb3csIChzdHJySWRJbWFnZSA6IHN0cmluZywgaW1nTmV3IDogYW55KSA9PiB7XHJcbiAgICAgICAgICBpZihpbWdOZXcgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgY29uc3QgcmVxID0gcmVuZGVyZXJUaGlzLm1fbWFwSW1hZ2VzLmdldChzdHJySWRJbWFnZSk7XHJcbiAgICAgICAgICAgIHJlcS5zZXRFcnJvcih0cnVlKTtcclxuICAgICAgICAgICAgLy9yZXR1cm47XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgcmVuZGVyZXJUaGlzLm1fbWFwSW1hZ2VzLnNldChzdHJySWRJbWFnZSwgaW1nTmV3KTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIGlmKGVDYW5WYXNTb3VyY2UgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICAgIGNvbnN0IGcgPSBlQ2FuVmFzU291cmNlLmdldENvbnRleHQoXCIyZFwiKTtcclxuICAgICAgICAgIGlmKGcgPT09IG51bGwpIHtcclxuICAgICAgICAgICAgcmV0dXJuO1xyXG4gICAgICAgICAgfVxyXG5cclxuICAgICAgICBsZXQgblhPZmZzZXQgPSBOYU47XHJcbiAgICAgICAgaWYoZUNhblZhc1NvdXJjZSAhPT0gZ3JpZC5jYW52YXMpIHsvL3Bpbm5lZCBjb2x1bW4sIG9yIHNvbWV0aGluZyBlbHNlXHJcbiAgICAgICAgICBuWE9mZnNldCA9IDA7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBwYWludEltYWdlUmVhZHkoZywgZ3JpZCwgc3RyQ29sTmFtZVRtcCwgc3RycklkSW1hZ2UsIGltZ05ldywgcmVuZGVyZXJUaGlzLnZhbHVlVG9JbWFnZUlkLCBuWE9mZnNldCk7XHJcbiAgICAgICB9KTtcclxuICAgICAgfVxyXG5cclxuICB9XHJcblxyXG4gIHJlbmRlcihnOiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIG5YOiBudW1iZXIsIG5ZOiBudW1iZXIsIG5XOiBudW1iZXIsIG5IOiBudW1iZXIsIHZhbHVlOiBhbnksIGNvbnRleHQ6IGFueSk6IHZvaWQge1xyXG5cclxuICAgIGlmKCFNYXRoVXRpbHMuaXNTdHJpY3RJbnQoblcpKSB7XHJcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ltYWdlIHdpZHRoIGlzIG5vdCBhbiBpbnRlZ2VyOiAnICsgblcgKyBcIiBXaWxsIGJlIGNvbnZlcnRlZCB0byBcIiArIE1hdGguZmxvb3IoblcpKTtcclxuICAgICAgblcgPSBNYXRoLmZsb29yKG5XKTtcclxuICAgIH1cclxuXHJcbiAgICBpZighTWF0aFV0aWxzLmlzU3RyaWN0SW50KG5IKSkge1xyXG4gICAgICBjb25zb2xlLmVycm9yKCdJbWFnZSBoZWlnaHQgaXMgbm90IGFuIGludGVnZXI6ICcgKyBuSCArIFwiIFdpbGwgYmUgY29udmVydGVkIHRvIFwiICsgTWF0aC5mbG9vcihuSCkpO1xyXG4gICAgICBuSCA9IE1hdGguZmxvb3IobkgpO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGNlbGxHcmlkOiBERy5HcmlkQ2VsbCA9IHZhbHVlO1xyXG4gICAgY29uc3Qgb2JWYWx1ZSA9IGNlbGxHcmlkLmNlbGwudmFsdWU7XHJcbiAgICBjb25zdCBzdHJJbWFnZUlkID0gdGhpcy52YWx1ZVRvSW1hZ2VJZChvYlZhbHVlKTtcclxuICAgIGlmIChzdHJJbWFnZUlkID09PSBudWxsIHx8IHN0ckltYWdlSWQgPT09IHVuZGVmaW5lZCB8fCBzdHJJbWFnZUlkID09ICcnKSB7XHJcbiAgICAgIGcuZmlsbFN0eWxlID0gJ3doaXRlJztcclxuICAgICAgZy5maWxsUmVjdChuWCwgblksIG5XLCBuSCk7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoIXRoaXMubV9iQ2VsbHNBZGp1c3RpbmcpIHtcclxuICAgICAgY29uc3QgaW1nID0gdGhpcy5tX21hcEltYWdlcy5nZXQoc3RySW1hZ2VJZCk7XHJcbiAgICAgIGlmICghKGltZyBpbnN0YW5jZW9mIEltYWdlUmVxdWVzdCkgJiYgaW1nICE9PSB1bmRlZmluZWQgJiYgaW1nICE9PSBudWxsICYmIGltZy53aWR0aCA9PT0gblcgJiYgaW1nLmhlaWdodCA9PT0gbkgpIHtcclxuICAgICAgICBnLmRyYXdJbWFnZShpbWcsIG5YLCBuWSwgblcsIG5IKTtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBnLmZpbGxTdHlsZSA9IFwiR3JheVwiO1xyXG4gICAgbGV0IHN0ciA9ICcnO1xyXG4gICAgaWYodGhpcy5tX2JDZWxsc0FkanVzdGluZykge1xyXG4gICAgICBzdHIgPSAnVXBkYXRpbmcuLi4nO1xyXG4gICAgfVxyXG4gICAgZWxzZSB7XHJcbiAgICAgIGNvbnN0IHJlcSA9IHRoaXMubV9tYXBJbWFnZXMuZ2V0KHN0ckltYWdlSWQpO1xyXG4gICAgICBpZihyZXEgaW5zdGFuY2VvZiBJbWFnZVJlcXVlc3QgJiYgcmVxLmlzRXJyb3IoKSkge1xyXG4gICAgICAgIHN0ciA9ICdFcnJvcic7XHJcbiAgICAgICAgZy5maWxsU3R5bGUgPSBcInJlZFwiO1xyXG4gICAgICB9XHJcbiAgICAgIGVsc2Uge1xyXG4gICAgICAgIHN0ciA9ICdMb2FkaW5nLi4uJztcclxuICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIC8vbGV0IHN0ciA9IHRoaXMubV9iQ2VsbHNBZGp1c3RpbmcgPyBcIlVwZGF0aW5nLi4uXCIgOiBcIkxvYWRpbmcuLi5cIjtcclxuXHJcbiAgICBnLmZvbnQgPSBjZWxsR3JpZC5zdHlsZS5mb250ID09PSBudWxsID8gXCIxMHB4IERpYWxvZ1wiIDogY2VsbEdyaWQuc3R5bGUuZm9udDtcclxuICAgIHN0ciA9IFRleHRVdGlscy50cmltVGV4dChzdHIsIGcsIG5XKTtcclxuXHJcbiAgICBjb25zdCB0bSA9IGcubWVhc3VyZVRleHQoc3RyKTtcclxuICAgIGxldCBuV0xhYmVsID0gdG0ud2lkdGg7XHJcblxyXG4gICAgY29uc3QgbkFzY2VudCA9IE1hdGguYWJzKHRtLmFjdHVhbEJvdW5kaW5nQm94QXNjZW50KTtcclxuICAgIGNvbnN0IG5EZXNjZW50ID0gdG0uYWN0dWFsQm91bmRpbmdCb3hEZXNjZW50O1xyXG4gICAgY29uc3QgbkhGb250ID0gbkFzY2VudCArIG5EZXNjZW50O1xyXG5cclxuICAgIGcudGV4dEFsaWduID0gJ3N0YXJ0JztcclxuXHJcbiAgICBjb25zdCBuWFggPSBuWCArICgoblcgLSBuV0xhYmVsKSA+PiAxKTtcclxuICAgIGNvbnN0IG5ZWSA9IG5ZICsgTWF0aC5mbG9vcigobkggKyBuSEZvbnQpIC8gMik7XHJcbiAgICBnLmZpbGxUZXh0KHN0ciwgblhYLCBuWVkpO1xyXG5cclxuICAgIGlmICh0aGlzLm1fYkNlbGxzQWRqdXN0aW5nKSB7XHJcbiAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBncmlkID0gY2VsbEdyaWQuZ3JpZDtcclxuICAgIGNvbnN0IHJlbmRlcmVyVGhpcyA9IHRoaXM7XHJcbiAgICBjb25zdCBzdHJDb2xOYW1lVG1wID0gY2VsbEdyaWQuZ3JpZENvbHVtbi5uYW1lO1xyXG5cclxuICAgIGxldCByZXF1ZXN0ID0gdGhpcy5tX21hcEltYWdlcy5nZXQoc3RySW1hZ2VJZCk7XHJcbiAgICBpZiAocmVxdWVzdCBpbnN0YW5jZW9mIEltYWdlUmVxdWVzdCAmJiByZXF1ZXN0LmlzTWF0Y2goc3RySW1hZ2VJZCwgblcsIG5IKSkge1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmVxdWVzdCA9IG5ldyBJbWFnZVJlcXVlc3Qoc3RySW1hZ2VJZCwgblcsIG5IKTtcclxuICAgIHRoaXMubV9tYXBJbWFnZXMuc2V0KHN0ckltYWdlSWQsIHJlcXVlc3QpO1xyXG5cclxuICAgIGNvbnN0IGVDYW52YXNUbXAgPSBnLmNhbnZhcztcclxuICAgIGxldCBuWE9mZnNldCA9IE5hTjtcclxuICAgIGlmKGcuY2FudmFzICE9PSBncmlkLmNhbnZhcykgey8vcGlubmVkIGNvbHVtbiwgb3Igc29tZXRoaW5nIGVsc2VcclxuICAgICAgblhPZmZzZXQgPSBuWDtcclxuICAgIH1cclxuXHJcbiAgICAvL2NvbnNvbGUubG9nKCdTZW5kaW5nIHJlcXVlc3QgOiAnICsgc3RySW1hZ2VJZCArIFwiIFwiICsgblcgKyBcIiBcIiArIG5IICsgXCIgXCIgKyBuWE9mZnNldCk7XHJcbiAgICB0aGlzLmNyZWF0ZUltYWdlKHN0ckltYWdlSWQsIG5XLCBuSCwgKHN0cklkSW1hZ2VSZWFkeTogc3RyaW5nLCBpbWdSZWFkeTogYW55KSA9PiB7XHJcbiAgICAgIGlmIChpbWdSZWFkeSA9PT0gbnVsbCkge1xyXG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSByZW5kZXJlclRoaXMubV9tYXBJbWFnZXMuZ2V0KHN0cklkSW1hZ2VSZWFkeSk7XHJcbiAgICAgICAgcmVxdWVzdC5zZXRFcnJvcih0cnVlKTtcclxuICAgICAgICAvL3JldHVybjtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICAvL2NvbnNvbGUubG9nKCdSZXF1ZXN0IFJlYWR5OiAnICsgc3RySW1hZ2VJZCArIFwiIFwiICsgblcgKyBcIiBcIiArIG5IKTtcclxuICAgICAgICByZW5kZXJlclRoaXMubV9tYXBJbWFnZXMuc2V0KHN0cklkSW1hZ2VSZWFkeSwgaW1nUmVhZHkpO1xyXG4gICAgICB9XHJcblxyXG4gICAgICBjb25zdCBncmFwaGljcyA9IGVDYW52YXNUbXAuZ2V0Q29udGV4dChcIjJkXCIpO1xyXG4gICAgICBpZiAoZ3JhcGhpY3MgPT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm47XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIHBhaW50SW1hZ2VSZWFkeShncmFwaGljcywgZ3JpZCwgc3RyQ29sTmFtZVRtcCwgc3RySWRJbWFnZVJlYWR5LCBpbWdSZWFkeSwgcmVuZGVyZXJUaGlzLnZhbHVlVG9JbWFnZUlkLCBuWE9mZnNldCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gcHJpdmF0ZSBtX21hcEltYWdlcyA9IG5ldyBNYXAoKTtcclxuIHByaXZhdGUgbV9iQ2VsbHNBZGp1c3RpbmcgPSBmYWxzZTtcclxufVxyXG4iXX0=